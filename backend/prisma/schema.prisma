generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ═══════════════════════════════════════
// USER & AUTH
// ═══════════════════════════════════════

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  passwordHash      String
  phone             String?
  whatsappNumber    String?
  telegramChatId    String?
  fcmTokens         String[]  @default([])
  
  role              Role      @default(USER)
  plan              Plan      @default(NONE)
  planExpiresAt     DateTime?
  stripeCustomerId  String?   @unique
  
  emailVerified           Boolean   @default(false)
  emailVerificationToken  String?
  passwordResetToken      String?
  passwordResetExpiresAt  DateTime?
  
  notifyEmail       Boolean   @default(true)
  notifyWhatsapp    Boolean   @default(false)
  notifyTelegram    Boolean   @default(false)
  notifySms         Boolean   @default(false)
  notifyFcm         Boolean   @default(false)
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  alerts            Alert[]
  payments          Payment[]
  notifications     Notification[]
  refreshTokens     RefreshToken[]
  auditLogs         AuditLog[]

  @@index([plan, planExpiresAt])
  @@index([role])
  @@index([createdAt])  // For admin user listing
}

enum Role {
  USER
  ADMIN
}

enum Plan {
  NONE
  URGENCE_24H
  URGENCE_7J
  URGENCE_TOTAL
}

// ═══════════════════════════════════════
// REFRESH TOKENS
// ═══════════════════════════════════════

model RefreshToken {
  id          String   @id @default(uuid())
  tokenHash   String   @unique
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt   DateTime
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

// ═══════════════════════════════════════
// STRIPE IDEMPOTENCY
// ═══════════════════════════════════════

model ProcessedStripeEvent {
  id          String   @id @default(uuid())
  eventId     String   @unique
  processedAt DateTime @default(now())

  @@index([processedAt])
}

// ═══════════════════════════════════════
// AUDIT LOG
// ═══════════════════════════════════════

model AuditLog {
  id           String   @id @default(uuid())
  userId       String?
  user         User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  action       String
  resourceType String
  resourceId   String?
  metadata     Json?
  ip           String?
  userAgent    String?
  createdAt    DateTime @default(now())

  @@index([userId, createdAt])
  @@index([action, createdAt])
}

// ═══════════════════════════════════════
// CLIENTS (For Booking Agent Business)
// ═══════════════════════════════════════

model Client {
  id              String        @id @default(uuid())
  
  // Contact Info
  firstName       String
  lastName        String
  email           String?
  phone           String
  
  // Procedure Details
  procedureType   ProcedureType // Specific procedure subtype
  prefectureId    String
  prefecture      Prefecture    @relation(fields: [prefectureId], references: [id])
  
  // Status
  status          ClientStatus  @default(WAITING)
  priority        Priority      @default(NORMAL)
  
  // Business
  priceAgreed     Float         // What you charge them
  amountPaid      Float         @default(0)
  amountDue       Float         @default(0)
  
  // Notes
  notes           String?       // Special requirements
  documentsReceived Boolean     @default(false)
  
  // Tracking
  alertId         String?       // Link to system alert
  alert           Alert?        @relation(fields: [alertId], references: [id])
  
  // Booking Result
  bookingDate     DateTime?     // When you booked it
  bookingTime     String?       // Time slot
  bookingUrl      String?       // Confirmation link
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([status, priority])
  @@index([prefectureId, status])
  @@index([procedureType, status])
}

enum ProcedureType {
  SALARIE_PAYSIPS
  ETUDIANT_RENEWAL
  CHANGEMENT_STATUT_ETUDIANT_SALARIE
  VIE_FAMILIALE_MARIAGE
  VIE_FAMILIALE_ENFANT
  ENTREPRENEUR
  DUPLICATA_PERDU
  RENEWAL_ANY
  NATURALISATION
  AUTRE
}

enum ClientStatus {
  WAITING         // En attente de créneau
  ALERT_SENT      // Créneau trouvé, alerte envoyée
  BOOKING_PENDING // En cours de réservation
  BOOKED          // RDV réservé
  COMPLETED       // RDV passé, service terminé
  CANCELLED       // Annulé
}

enum Priority {
  NORMAL
  URGENT_7DAYS
  EMERGENCY_24H
}

// ═══════════════════════════════════════
// ALERTS
// ═══════════════════════════════════════

model Alert {
  id              String      @id @default(uuid())
  userId          String
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  prefectureId    String
  prefecture      Prefecture  @relation(fields: [prefectureId], references: [id])
  procedure       Procedure
  isActive        Boolean     @default(true)
  
  lastCheckedAt   DateTime?
  slotsFound      Int         @default(0)
  notificationsSent Int       @default(0)
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  detections      Detection[]
  clients         Client[]  // Clients linked to this alert
  
  @@unique([userId, prefectureId, procedure])
  @@index([prefectureId, isActive])
  @@index([userId])
  @@index([userId, isActive, createdAt])  // For listing user's active alerts
}

enum Procedure {
  // Titre de séjour - Main categories
  TITRE_SEJOUR                    // Generic (for prefectures that don't specify)
  TITRE_SEJOUR_SALARIE            // Employee/work contract
  TITRE_SEJOUR_ETUDIANT           // Student
  TITRE_SEJOUR_ENTREPRENEUR       // Self-employed/business owner
  TITRE_SEJOUR_VPF                // Vie privée et familiale (marriage/family)
  TITRE_SEJOUR_RENOUVELLEMENT     // Renewal (any type)
  TITRE_SEJOUR_DUPLICATA          // Lost/stolen card replacement
  
  // Change of status
  CHANGEMENT_STATUT_ETUDIANT_SALARIE  // Student → Employee
  CHANGEMENT_STATUT_AUTRE             // Other status changes
  
  // Other procedures
  NATURALISATION
  VISA
  CARTE_IDENTITE
  PASSEPORT
  PERMIS_CONDUIRE
  CARTE_GRISE
  AUTRE
}

// ═══════════════════════════════════════
// DETECTIONS
// ═══════════════════════════════════════

model Detection {
  id              String    @id @default(uuid())
  alertId         String
  alert           Alert     @relation(fields: [alertId], references: [id], onDelete: Cascade)
  
  prefectureId    String
  prefecture      Prefecture @relation(fields: [prefectureId], references: [id])
  slotsAvailable  Int
  slotDate        String?
  slotTime        String?
  bookingUrl      String
  screenshotPath  String?
  
  detectedAt      DateTime  @default(now())
  
  @@index([prefectureId, detectedAt])
  @@index([alertId])
}

// ═══════════════════════════════════════
// PREFECTURE CONFIG
// ═══════════════════════════════════════

model Prefecture {
  id              String    @id
  name            String
  department      String
  region          String
  tier            Int       @default(3)
  
  bookingUrl      String
  checkInterval   Int       @default(120)
  selectors       Json
  
  status          PrefectureStatus @default(ACTIVE)
  lastScrapedAt   DateTime?
  lastSlotFoundAt DateTime?
  consecutiveErrors Int     @default(0)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  alerts          Alert[]
  detections      Detection[]
  scraperLogs     ScraperLog[]
  clients         Client[]  // For booking agent business
  
  @@index([tier, status])
}

enum PrefectureStatus {
  ACTIVE
  PAUSED
  ERROR
  CAPTCHA
}

// ═══════════════════════════════════════
// PAYMENTS
// ═══════════════════════════════════════

model Payment {
  id                String    @id @default(uuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id])
  
  stripePaymentId   String    @unique
  stripeSessionId   String?
  
  plan              Plan
  amount            Int
  currency          String    @default("eur")
  status            PaymentStatus @default(PENDING)
  
  createdAt         DateTime  @default(now())
  paidAt            DateTime?
  refundedAt        DateTime?
  
  @@index([userId, createdAt])
  @@index([status, createdAt])  // For admin payment filtering
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// ═══════════════════════════════════════
// NOTIFICATIONS
// ═══════════════════════════════════════

model Notification {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  
  channel     NotificationChannel
  type        String
  title       String
  body        String
  metadata    Json?
  
  status      NotificationDeliveryStatus @default(PENDING)
  sentAt      DateTime?
  failedAt    DateTime?
  errorMsg    String?
  
  createdAt   DateTime  @default(now())
  
  @@index([userId, createdAt])
  @@index([status])
  @@index([channel, status])  // For channel-specific queries
  @@index([createdAt])        // For cleanup queries
}

enum NotificationChannel {
  EMAIL
  SMS
  WHATSAPP
  TELEGRAM
  WEBSOCKET
  FCM
}

enum NotificationDeliveryStatus {
  PENDING
  SENT
  FAILED
}

// ═══════════════════════════════════════
// SCRAPER LOGS
// ═══════════════════════════════════════

model ScraperLog {
  id              String    @id @default(uuid())
  prefectureId    String
  prefecture      Prefecture @relation(fields: [prefectureId], references: [id])
  workerId        String
  
  status          String
  slotsFound      Int       @default(0)
  responseTimeMs  Int
  errorMessage    String?
  screenshotPath  String?
  
  createdAt       DateTime  @default(now())
  
  @@index([prefectureId, createdAt])
  @@index([status, createdAt])
}
