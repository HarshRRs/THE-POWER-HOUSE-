generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ═══════════════════════════════════════
// USER & AUTH
// ═══════════════════════════════════════

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  passwordHash      String
  phone             String?
  whatsappNumber    String?
  telegramChatId    String?
  fcmTokens         String[]  @default([])
  
  role              Role      @default(USER)
  plan              Plan      @default(NONE)
  planExpiresAt     DateTime?
  stripeCustomerId  String?   @unique
  
  emailVerified           Boolean   @default(false)
  emailVerificationToken  String?
  passwordResetToken      String?
  passwordResetExpiresAt  DateTime?
  
  notifyEmail       Boolean   @default(true)
  notifyWhatsapp    Boolean   @default(false)
  notifyTelegram    Boolean   @default(false)
  notifySms         Boolean   @default(false)
  notifyFcm         Boolean   @default(false)
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  alerts            Alert[]
  payments          Payment[]
  notifications     Notification[]
  refreshTokens     RefreshToken[]
  auditLogs         AuditLog[]
  pushSubscriptions PushSubscription[]

  @@index([plan, planExpiresAt])
  @@index([role])
  @@index([createdAt])  // For admin user listing
}

enum Role {
  USER
  ADMIN
}

enum Plan {
  NONE
  URGENCE_24H
  URGENCE_7J
  URGENCE_TOTAL
}

// ═══════════════════════════════════════
// REFRESH TOKENS
// ═══════════════════════════════════════

model RefreshToken {
  id          String   @id @default(uuid())
  tokenHash   String   @unique
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt   DateTime
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

// ═══════════════════════════════════════
// STRIPE IDEMPOTENCY
// ═══════════════════════════════════════

model ProcessedStripeEvent {
  id          String   @id @default(uuid())
  eventId     String   @unique
  processedAt DateTime @default(now())

  @@index([processedAt])
}

// ═══════════════════════════════════════
// AUDIT LOG
// ═══════════════════════════════════════

model AuditLog {
  id           String   @id @default(uuid())
  userId       String?
  user         User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  action       String
  resourceType String
  resourceId   String?
  metadata     Json?
  ip           String?
  userAgent    String?
  createdAt    DateTime @default(now())

  @@index([userId, createdAt])
  @@index([action, createdAt])
}

// ═══════════════════════════════════════
// CLIENTS (For Booking Agent Business)
// ═══════════════════════════════════════

model Client {
  id              String        @id @default(uuid())
  
  // Contact Info
  firstName       String
  lastName        String
  email           String?       // Booking confirmation goes here
  phone           String
  
  // Personal Details (for form filling)
  dateOfBirth     DateTime?
  nationality     String        @default("Indian")
  passportNumber  String?
  foreignerNumber String?       // AGDREF number (for prefecture renewals)
  passportFileNumber String?    // For Indian Embassy bookings
  
  // Booking Target System
  bookingSystem   BookingSystem @default(PREFECTURE)
  
  // Prefecture-specific
  procedureType   ProcedureType // Specific procedure subtype
  prefectureId    String?
  prefecture      Prefecture?   @relation(fields: [prefectureId], references: [id])
  procedure       Procedure?    // Links to alert/detection system
  
  // VFS-specific
  vfsCenterId     String?
  vfsCenter       VfsCenter?    @relation(fields: [vfsCenterId], references: [id])
  vfsLoginEmail   String?
  vfsLoginPassword String?      // Encrypted
  destinationCountry String?
  preferredCity   String?
  visaCategory    String?
  
  // Embassy-specific
  embassyServiceType String?    // e.g., PASSPORT_RENEWAL, OCI_REGISTRATION
  consulateId     String?
  consulate       Consulate?    @relation(fields: [consulateId], references: [id])
  
  // Date Preferences
  datePreference  DatePreference @default(EARLIEST)
  preferredAfter  DateTime?     // Book after this date
  preferredBefore DateTime?     // Book before this date
  
  // Auto-Booking
  autoBook        Boolean       @default(false)
  bookingStatus   BookingStatus @default(IDLE)
  bookingAttempts Int           @default(0)
  lastAttemptAt   DateTime?
  lastAttemptError String?
  
  // Status
  status          ClientStatus  @default(WAITING)
  priority        Priority      @default(NORMAL)
  
  // Business
  priceAgreed     Float         // What you charge them
  amountPaid      Float         @default(0)
  amountDue       Float         @default(0)
  
  // Notes
  notes           String?       // Special requirements
  documentsReceived Boolean     @default(false)
  
  // Tracking
  alertId         String?       // Link to system alert
  alert           Alert?        @relation(fields: [alertId], references: [id])
  
  // Booking Result
  bookingDate     DateTime?     // When the appointment is
  bookingTime     String?       // Time slot
  bookingUrl      String?       // Confirmation link
  bookingRef      String?       // Reference number from confirmation
  bookingScreenshot String?     // Screenshot path of confirmation
  bookedAt        DateTime?     // When the system booked it
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  bookingLogs     BookingLog[]
  
  @@index([status, priority])
  @@index([prefectureId, status])
  @@index([procedureType, status])
  @@index([bookingSystem, autoBook, bookingStatus])
  @@index([vfsCenterId, status])
}

enum BookingSystem {
  PREFECTURE
  VFS
  EMBASSY
}

enum BookingStatus {
  IDLE          // Not actively booking
  WAITING_SLOT  // Waiting for slot to appear
  BOOKING       // Currently in booking process
  CAPTCHA_WAIT  // Waiting for CAPTCHA solve (manual or 2Captcha)
  PAYMENT_WAIT  // VFS: waiting for admin to complete payment
  BOOKED        // Successfully booked
  FAILED        // Booking failed
}

enum DatePreference {
  EARLIEST      // First available date
  AFTER         // After preferredAfter date
  BEFORE        // Before preferredBefore date
  BETWEEN       // Between preferredAfter and preferredBefore
}

// Booking attempt log for audit trail
model BookingLog {
  id              String    @id @default(uuid())
  clientId        String
  client          Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  action          String    // SLOT_DETECTED, FORM_FILLED, CAPTCHA_SENT, CAPTCHA_SOLVED, SUBMITTED, BOOKED, FAILED
  details         String?   // Extra info
  screenshotPath  String?   // Screenshot at this step
  
  createdAt       DateTime  @default(now())
  
  @@index([clientId, createdAt])
}

enum ProcedureType {
  SALARIE_PAYSIPS
  ETUDIANT_RENEWAL
  CHANGEMENT_STATUT_ETUDIANT_SALARIE
  VIE_FAMILIALE_MARIAGE
  VIE_FAMILIALE_ENFANT
  ENTREPRENEUR
  DUPLICATA_PERDU
  RENEWAL_ANY
  NATURALISATION
  AUTRE
}

enum ClientStatus {
  WAITING         // En attente de créneau
  ALERT_SENT      // Créneau trouvé, alerte envoyée
  BOOKING_PENDING // En cours de réservation
  BOOKED          // RDV réservé
  COMPLETED       // RDV passé, service terminé
  CANCELLED       // Annulé
}

enum Priority {
  NORMAL
  URGENT_7DAYS
  EMERGENCY_24H
}

// ═══════════════════════════════════════
// ALERTS
// ═══════════════════════════════════════

model Alert {
  id              String      @id @default(uuid())
  userId          String
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  targetType      TargetType  @default(PREFECTURE)
  
  prefectureId    String?
  prefecture      Prefecture? @relation(fields: [prefectureId], references: [id])
  
  consulateId     String?
  consulate       Consulate?  @relation(fields: [consulateId], references: [id])
  
  vfsCenterId     String?
  vfsCenter       VfsCenter?  @relation(fields: [vfsCenterId], references: [id])
  
  procedure       Procedure
  isActive        Boolean     @default(true)
  
  lastCheckedAt   DateTime?
  slotsFound      Int         @default(0)
  notificationsSent Int       @default(0)
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  detections      Detection[]
  clients         Client[]  // Clients linked to this alert
  
  @@unique([userId, prefectureId, procedure])
  @@unique([userId, consulateId, procedure])
  @@unique([userId, vfsCenterId, procedure])
  @@index([prefectureId, isActive])
  @@index([consulateId, isActive])
  @@index([vfsCenterId, isActive])
  @@index([userId])
  @@index([userId, isActive, createdAt])  // For listing user's active alerts
}

enum Procedure {
  // Titre de séjour - Main categories
  TITRE_SEJOUR                    // Generic (for prefectures that don't specify)
  TITRE_SEJOUR_SALARIE            // Employee/work contract
  TITRE_SEJOUR_ETUDIANT           // Student
  TITRE_SEJOUR_ENTREPRENEUR       // Self-employed/business owner
  TITRE_SEJOUR_VPF                // Vie privée et familiale (marriage/family)
  TITRE_SEJOUR_RENOUVELLEMENT     // Renewal (any type)
  TITRE_SEJOUR_DUPLICATA          // Lost/stolen card replacement
  
  // Change of status
  CHANGEMENT_STATUT_ETUDIANT_SALARIE  // Student → Employee
  CHANGEMENT_STATUT_AUTRE             // Other status changes
  
  // Other procedures
  NATURALISATION
  VISA
  CARTE_IDENTITE
  PASSEPORT
  PERMIS_CONDUIRE
  CARTE_GRISE
  AUTRE

  // Indian Embassy - Passport
  PASSPORT_RENEWAL
  PASSPORT_REISSUE
  PASSPORT_NEW
  PASSPORT_TATKAL
  // Indian Embassy - OCI
  OCI_REGISTRATION
  OCI_RENEWAL
  OCI_MISC
  // Indian Embassy - Other
  VISA_CONSULAR
  BIRTH_REGISTRATION
  CONSULAR_OTHER

  // VFS Italy (from India) - Schengen & National visas
  SCHENGEN_TOURIST_ITALY
  SCHENGEN_BUSINESS_ITALY
  STUDENT_VISA_ITALY
  WORK_VISA_ITALY
  SEASONAL_WORK_VISA_ITALY       // Seasonal Work (National D)

  // VFS Germany (from India) - Schengen & National visas
  SCHENGEN_TOURIST_GERMANY
  SCHENGEN_BUSINESS_GERMANY
  STUDENT_VISA_GERMANY
  WORK_VISA_GERMANY
  OPPORTUNITY_CARD_GERMANY       // Chancenkarte (National D)

  // VFS France (from India) - Schengen & National visas
  SCHENGEN_TOURIST_FRANCE
  SCHENGEN_BUSINESS_FRANCE
  STUDENT_VISA_FRANCE
  WORK_VISA_FRANCE

  // VFS Switzerland (from India) - Schengen & National visas
  SCHENGEN_TOURIST_SWITZERLAND
  SCHENGEN_BUSINESS_SWITZERLAND
  STUDENT_VISA_SWITZERLAND
  WORK_VISA_SWITZERLAND

  // VFS Austria (from India) - Schengen & National visas
  SCHENGEN_TOURIST_AUSTRIA
  SCHENGEN_BUSINESS_AUSTRIA
  STUDENT_VISA_AUSTRIA
  WORK_VISA_AUSTRIA

  // VFS Belgium (from India) - Schengen & National visas
  SCHENGEN_TOURIST_BELGIUM
  SCHENGEN_BUSINESS_BELGIUM
  STUDENT_VISA_BELGIUM
  WORK_VISA_BELGIUM

  // VFS Netherlands (from India) - Schengen & National visas
  SCHENGEN_TOURIST_NETHERLANDS
  SCHENGEN_BUSINESS_NETHERLANDS
  STUDENT_VISA_NETHERLANDS
  WORK_VISA_NETHERLANDS

  // VFS Portugal (from India) - Schengen & National visas
  SCHENGEN_TOURIST_PORTUGAL
  SCHENGEN_BUSINESS_PORTUGAL
  STUDENT_VISA_PORTUGAL
  WORK_VISA_PORTUGAL
  JOB_SEEKER_VISA_PORTUGAL       // Job Seeker Visa (National D)
}

enum TargetType {
  PREFECTURE
  CONSULATE
  VFS_CENTER
}

enum ConsulateStatus {
  ACTIVE
  PAUSED
  ERROR
}

// ═══════════════════════════════════════
// DETECTIONS
// ═══════════════════════════════════════

model Detection {
  id              String    @id @default(uuid())
  alertId         String
  alert           Alert     @relation(fields: [alertId], references: [id], onDelete: Cascade)
  
  prefectureId    String?
  prefecture      Prefecture? @relation(fields: [prefectureId], references: [id])
  
  consulateId     String?
  consulate       Consulate?  @relation(fields: [consulateId], references: [id])
  
  vfsCenterId     String?
  vfsCenter       VfsCenter?  @relation(fields: [vfsCenterId], references: [id])
  
  slotsAvailable  Int
  slotDate        String?
  slotTime        String?
  bookingUrl      String
  screenshotPath  String?
  
  detectedAt      DateTime  @default(now())
  
  @@index([prefectureId, detectedAt])
  @@index([consulateId, detectedAt])
  @@index([vfsCenterId, detectedAt])
  @@index([alertId])
}

// ═══════════════════════════════════════
// PREFECTURE CONFIG
// ═══════════════════════════════════════

model Prefecture {
  id              String    @id
  name            String
  department      String
  region          String
  tier            Int       @default(3)
  
  bookingUrl      String
  originalBookingUrl String?           // Never changes, reference point
  checkInterval   Int       @default(120)
  selectors       Json
  
  status          PrefectureStatus @default(ACTIVE)
  lastScrapedAt   DateTime?
  lastSlotFoundAt DateTime?
  consecutiveErrors Int     @default(0)
  
  // URL Discovery fields
  urlLastValidatedAt     DateTime?
  urlConsecutiveFailures Int       @default(0)
  urlDiscoveryEnabled    Boolean   @default(true)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  alerts          Alert[]
  detections      Detection[]
  scraperLogs     ScraperLog[]
  clients         Client[]  // For booking agent business
  urlHistory      UrlHistory[]
  
  @@index([tier, status])
}

enum PrefectureStatus {
  ACTIVE
  PAUSED
  ERROR
  CAPTCHA
}

// ═══════════════════════════════════════
// PAYMENTS
// ═══════════════════════════════════════

model Payment {
  id                String    @id @default(uuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id])
  
  stripePaymentId   String    @unique
  stripeSessionId   String?
  
  plan              Plan
  amount            Int
  currency          String    @default("eur")
  status            PaymentStatus @default(PENDING)
  
  createdAt         DateTime  @default(now())
  paidAt            DateTime?
  refundedAt        DateTime?
  
  @@index([userId, createdAt])
  @@index([status, createdAt])  // For admin payment filtering
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// ═══════════════════════════════════════
// NOTIFICATIONS
// ═══════════════════════════════════════

model Notification {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  
  channel     NotificationChannel
  type        String
  title       String
  body        String
  metadata    Json?
  
  status      NotificationDeliveryStatus @default(PENDING)
  sentAt      DateTime?
  failedAt    DateTime?
  errorMsg    String?
  
  createdAt   DateTime  @default(now())
  
  @@index([userId, createdAt])
  @@index([status])
  @@index([channel, status])  // For channel-specific queries
  @@index([createdAt])        // For cleanup queries
}

enum NotificationChannel {
  EMAIL
  SMS
  WHATSAPP
  TELEGRAM
  WEBSOCKET
  FCM
}

enum NotificationDeliveryStatus {
  PENDING
  SENT
  FAILED
}

// ═══════════════════════════════════════
// PUSH SUBSCRIPTIONS (For Web Push Notifications)
// ═══════════════════════════════════════

model PushSubscription {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  endpoint  String   @unique
  p256dh    String
  auth      String
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@unique([userId, endpoint])
}

// ═══════════════════════════════════════
// SCRAPER LOGS
// ═══════════════════════════════════════

model ScraperLog {
  id              String    @id @default(uuid())
  prefectureId    String
  prefecture      Prefecture @relation(fields: [prefectureId], references: [id])
  workerId        String
  
  status          String
  slotsFound      Int       @default(0)
  responseTimeMs  Int
  errorMessage    String?
  screenshotPath  String?
  
  // URL tracking fields
  finalUrl        String?
  redirectCount   Int       @default(0)
  urlChanged      Boolean   @default(false)
  
  createdAt       DateTime  @default(now())
  
  @@index([prefectureId, createdAt])
  @@index([status, createdAt])
}

// ═══════════════════════════════════════
// CONSULATE CONFIG
// ═══════════════════════════════════════

model Consulate {
  id                String          @id
  name              String
  country           String
  city              String
  type              String          // "embassy", "consulate"
  baseUrl           String
  checkInterval     Int             @default(120)
  
  status            ConsulateStatus @default(ACTIVE)
  lastScrapedAt     DateTime?
  consecutiveErrors Int             @default(0)
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  alerts            Alert[]
  detections        Detection[]
  clients           Client[]
  
  @@index([status])
}

// ═══════════════════════════════════════
// VFS CENTER CONFIG (European Visas from India)
// ═══════════════════════════════════════

model VfsCenter {
  id                  String        @id
  configId            String        // Reference to VfsConfig (e.g., 'vfs-italy-india')
  name                String        // e.g., 'VFS Italy - New Delhi'
  destinationCountry  String        // e.g., 'Italy'
  sourceCountry       String        // e.g., 'India'
  city                String        // e.g., 'New Delhi'
  centerCode          String        // VFS center code
  bookingUrl          String
  checkInterval       Int           @default(300) // 5 minutes default
  
  status              VfsCenterStatus @default(ACTIVE)
  lastScrapedAt       DateTime?
  lastSlotFoundAt     DateTime?
  consecutiveErrors   Int           @default(0)
  
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  
  alerts              Alert[]
  detections          Detection[]
  clients             Client[]
  
  @@index([configId, status])
  @@index([destinationCountry, status])
  @@index([status])
}

enum VfsCenterStatus {
  ACTIVE
  PAUSED
  ERROR
  CAPTCHA_BLOCKED
}

// ═══════════════════════════════════════
// URL DISCOVERY (Auto-healing URL system)
// ═══════════════════════════════════════

model UrlHistory {
  id                String              @id @default(uuid())
  prefectureId      String
  prefecture        Prefecture          @relation(fields: [prefectureId], references: [id], onDelete: Cascade)
  
  oldUrl            String
  newUrl            String
  redirectChain     Json                // Array of URLs in redirect path
  
  discoveryMethod   UrlDiscoveryMethod
  validationStatus  UrlValidationStatus @default(PENDING)
  confidence        Float               // 0-1 confidence score
  validationDetails Json?               // Indicators found during validation
  
  appliedAt         DateTime?           // When URL was actually updated
  discoveredBy      String?             // Worker ID or admin user ID
  
  createdAt         DateTime            @default(now())
  
  @@index([prefectureId, createdAt])
  @@index([validationStatus])
}

enum UrlDiscoveryMethod {
  REDIRECT        // Detected via HTTP redirect
  PATTERN_MATCH   // Found via pattern-based search
  ADMIN_UPDATE    // Manually updated by admin
  FALLBACK        // Found via fallback URL attempt
}

enum UrlValidationStatus {
  PENDING         // Awaiting admin approval
  VALIDATED       // Admin approved
  REJECTED        // Admin rejected
  AUTO_APPROVED   // Auto-approved (high confidence)
}
